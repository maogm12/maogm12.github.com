<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<title>字根练习</title>
	<style>
		#container {
			position: relative;
			display: inline-block;
			left: 50%;
			transform: translate(-50%);
			height: 200px;
		}

		#menu-button {
			position: fixed;
			top: 10px;
			right: 10px;
			z-index: 9999;
			font-size: 20px;
		}

		#menu {
			position: fixed;
			top: 50px;
			right: 10px;
			background-color: #ffffff;
			border: 1px solid #ccc;
			padding: 10px;
			z-index: 9999;
		}

		#glyph-card {
			font-size: 150px;
			display: inline-block;
			width: 100px;
			height: 200px;
		}

		#glyph-card span {
			position: absolute;
			left: 50%;
			transform: translate(-50%);
		}

		#glyph {
			top: 0;
			color: black;
		}

		#glyph-context {
			top: 0;
			color: rgb(229, 229, 234);
		}

		#answer {
			text-align: center;
			cursor: none;
			outline: none;
			border: none;
			border-bottom: 1px solid black;
			margin: 0 auto 0;
			font-family: monospace;
			font-size: 50px;
			text-transform: capitalize;
			display: block;
			width: 50%;
		}

		#tips {
			text-align: center;
			border: 1px solid lightgray;
			border-radius: 4px;
		}

		#notes {
			list-style-type: none;
			list-style-position: inside;
			padding-left: 0;
		}

		.note-key {
			border: 1px solid gray;
			font-family: monospace;
			border-radius: 4px;
			width: 15px;
			height: 15px;
			display: inline-block;
			text-align: center;
			margin-right: 5px;
		}

		@media (prefers-color-scheme: dark) {
			#glyph-context {
				color: rgb(44, 44, 46);
			}
		}
	</style>
</head>

<body>
	<button id="menu-button">☰</button>
	<div id="menu" style="display: none;">
		<label for="zigen-categories">字根分区:</label>
		<select name="zigen-categories" id="zigen-categories"></select>
		<br>
		<label for="random">随机展示字根：</label>
		<input type="checkbox" name="random" id="random">
		<br>
		<label for="show-code">显示编码：</label>
		<input type="checkbox" name="show-code" id="show-code">
		<br>
		<label for="show-tips">打开提示：</label>
		<input type="checkbox" name="show-tips" id="show-tips">
		<br>
		<label for="answer-len">答案长度：</label>
		<input type="number" name="answer-len" id="answer-len">
	</div>
	<div id="glyph-card">
		<span id="glyph-context">
		</span>

		<span id="glyph">
		</span>
	</div>

	<input type="text" id="answer">

	<p>
	<div id="tips"></div>
	<ul id="notes"></ul>
	</p>

	<script>
		class App {
			// elements
			menuButton;
			menuContainer;
			randomInput;
			showCodeInput;
			showTipsInput;
			answerLenInput;
			categoryOptions;
			answerInput;
			tipsDiv;
			noteUl;
			glyphCard;
			glyph;
			glyphContext;

			zigenConfig = null;
			currentGlyphs = null;
			currentIndex = 0;
			currentGlyph = null;

			constructor() {
				// menu container
				this.menuButton = document.getElementById('menu-button');
				this.menuContainer = document.getElementById('menu');
				this.randomInput = document.getElementById('random');
				this.showCodeInput = document.getElementById('show-code');
				this.showTipsInput = document.getElementById('show-tips');
				this.answerLenInput = document.getElementById('answer-len');
				this.initMenu();

				// categories
				this.categoryOptions = document.getElementById("zigen-categories");
				this.initCategories();

				// glyph
				this.glyphCard = document.getElementById('glyph-card');
				this.glyph = document.getElementById('glyph');
				this.glyphContext = document.getElementById('glyph-context');

				// answer
				this.answerInput = document.getElementById('answer');
				this.initAnswer();

				// tips
				this.tipsDiv = document.getElementById('tips');

				// notes
				this.noteUl = document.getElementById('notes');

				this.init();
			}

			// getters
			get shouldShowRandomZigen() {
				return this.randomInput.checked;
			}

			get shouldShowTips() {
				return this.showTipsInput.checked;
			}

			get shouldShowCode() {
				return this.showCodeInput.checked;
			}

			get configName() {
				return this.zigenConfig ? this.zigenConfig.name : "";
			}

			get configVersion() {
				return this.zigenConfig ? this.zigenConfig.version : "";
			}

			get maxAnswerLength() {
				return this.answerLenInput.value;
			}

			init() {
				this.categoryOptions.innerHTML = "";
				this.categoryIndex = 0;
				this.currentIndex = 0;

				this.answerInput.value = "";
				this.tipsDiv.innerHTML = "";
				this.noteUl.innerHTML = "";
			}

			// init menu
			initMenu() {
				const self = this;

				// menu container
				this.menuButton.addEventListener('click', function () {
					self.toggleMenu();
				});

				window.addEventListener('click', function (event) {
					if (event.target != self.menuButton && !self.menuContainer.contains(event.target)) {
						self.hideMenu();
					}
				});

				// random option
				this.randomInput.checked = localStorage.getItem('random') == 'true';
				this.randomInput.onchange = function () {
					localStorage.setItem('random', self.randomInput.checked);
					self.renderZigen();
				}

				// show code
				this.showCodeInput.checked = localStorage.getItem('show-code') == 'true';
				this.showCodeInput.onchange = function () {
					localStorage.setItem('show-code', self.showCodeInput.checked);
					self.refreshCode();
				}

				// show tips option
				this.showTipsInput.checked = localStorage.getItem('show-tips') == 'true';
				this.showTipsInput.onchange = function () {
					localStorage.setItem('show-tips', self.showTipsInput.checked);
					self.refreshTips();
				}
			}

			initCategories() {
				const self = this;
				this.categoryOptions.addEventListener('change', function () {
					self.didSelectCategory(true);
				});
			}

			initAnswer() {
				const self = this;
				this.answerInput.addEventListener('keydown', function (event) {
					if (event.key === 'Backspace') {
						return true;
					}

					// Check if the key pressed is a letter
					if (event.key.match(/[a-z]/i) && self.answerInput.value.length < self.currentGlyph.code.length) {
						return true;
					} else {
						// Prevent any other key from being pressed
						event.preventDefault();
						return false;
					}
				});

				this.answerInput.addEventListener('input', function () {
					const answer = self.answerInput.value;
					const noError = self.currentGlyph.code.toLowerCase().startsWith(answer.toLowerCase());

					if (noError) {
						self.answerInput.style.color = "green";
					} else {
						self.answerInput.style.color = "red";
					}

					if (answer.toLowerCase() == self.currentGlyph.code.toLowerCase() ||
						(noError && answer.length >= self.maxAnswerLength)) {
						self.answerInput.value = "";
						self.renderZigen();
					}
				});

				this.answerInput.addEventListener('focus', function () {
					window.scrollTo({ top: 0, behavior: 'smooth' });

					// move cursor to end
					var currentValue = self.answerInput.value;
					self.answerInput.value = "";
					self.answerInput.value = currentValue;
				});
			}

			// config
			loadConfig(configUrl) {
				fetch(configUrl)
					.then((response) => response.json())
					.then((json) => {
						// loaded config
						console.log('Loaded config');
						this.zigenConfig = json;

						this.loadFont();

						document.title = this.configName + ' ' + this.configVersion;
						this.loadNotes();

						this.configCategories();
						this.loadAnswerLength();
					}).catch((error) => {
						console.error('Error loading config', error);
					});
			}

			// menu
			hideMenu() {
				this.menuContainer.style.display = 'none';
			}

			toggleMenu() {
				this.menuContainer.style.display = this.menuContainer.style.display == 'none' ? 'block' : 'none';
			}

			refreshCode() {
				if (!this.zigenConfig || !this.currentGlyph) {
					throw new Error("No config or glyph");
				}

				if (this.shouldShowCode) {
					this.answerInput.placeholder = this.currentGlyph.code;
				} else {
					this.answerInput.placeholder = "";
				}
			}

			refreshTips() {
				if (!this.zigenConfig || !this.currentGlyph) {
					throw new Error("No config or glyph");
				}

				if (this.shouldShowTips) {
					this.tipsDiv.hidden = false;
					this.tipsDiv.innerHTML = "";
					this.zigenConfig.notes.forEach(note => {
						if (this.currentGlyph.code.toLowerCase().startsWith(note.startsWith.toLowerCase())) {
							if (this.tipsDiv.innerHTML != "") {
								this.tipsDiv.innerHTML += "<br>";
							}
							this.tipsDiv.innerHTML = note.content;
						}
					});
				} else {
					this.tipsDiv.hidden = true;
				}
			}

			// Categories
			configCategories() {
				if (!this.zigenConfig) {
					throw new Error("No config");
				}

				this.categoryOptions.innerHTML = "";
				Object.entries(this.zigenConfig.categories).forEach(([index, category]) => {
					var option = document.createElement("option");
					option.value = index;
					option.text = category.name;
					this.categoryOptions.add(option);
				});

				var categoryKey = `${this.zigenConfig.name}_${this.zigenConfig.version}_category`;
				var indexKey = `${this.zigenConfig.name}_${this.zigenConfig.version}_index`;
				let cachedCategory = localStorage.getItem(categoryKey);
				if (!!cachedCategory) {
					this.categoryOptions.selectedIndex = cachedCategory;
					console.log(`Restoring category [${categoryKey}: ${cachedCategory}]`)

					this.currentIndex = localStorage.getItem(indexKey) || 0;
					console.log(`Restoring index [${indexKey}: ${this.currentIndex}]`);
				} else {
					this.categoryOptions.selectedIndex = 0;
					this.currentIndex = 0;
					localStorage.removeItem(indexKey);
				}

				this.didSelectCategory(false);
			}

			didSelectCategory(manualTrigger = false) {
				this.categoryIndex = this.categoryOptions.options[this.categoryOptions.selectedIndex].value;
				var codes = this.zigenConfig.categories[this.categoryIndex].codes;
				this.currentGlyphs = this.zigenConfig.glyphs.filter(glyph => codes.includes(glyph.code));

				if (manualTrigger) {
					var categoryKey = `${this.zigenConfig.name}_${this.zigenConfig.version}_category`;
					localStorage.setItem(categoryKey, this.categoryOptions.selectedIndex);

					this.currentIndex = 0;
				}

				this.hideMenu();
				this.renderZigen(false);
			}

			loadFont() {
				if (!this.zigenConfig) {
					throw new Error("No config");
				}

				if (!this.zigenConfig.font) {
					console.log("No font in config");
					return;
				}

				const zigenFont = new FontFace(this.zigenConfig.fontName, 'url(' + this.zigenConfig.font + ')');
				document.fonts.add(zigenFont);
				zigenFont.load().then(
					() => {
						// font loaded successfully!
						this.glyphCard.style.fontFamily = this.zigenConfig.fontName;
					},
					(err) => {
						console.error(err);
					},);
			}

			loadNotes() {
				if (!this.zigenConfig) {
					throw new Error("No config");
				}

				this.noteUl.innerHTML = "";
				this.zigenConfig.notes.forEach(note => {
					var li = document.createElement('li');
					var keySpan = document.createElement('span');
					keySpan.classList.add('note-key');
					keySpan.innerText = note.startsWith;
					li.appendChild(keySpan);
					var noteSpan = document.createElement('span');
					noteSpan.innerText = note.content;
					li.appendChild(noteSpan);
					this.noteUl.appendChild(li);
				});
			}

			loadAnswerLength() {
				if (!this.zigenConfig) {
					throw new Error("No config");
				}

				const self = this;

				var maxCodeLen = 0;
				this.zigenConfig.glyphs.forEach(glyph => {
					if (maxCodeLen < glyph.code.length) {
						maxCodeLen = glyph.code.length;
					}
				});

				if (maxCodeLen == 0) {
					throw new Error("No code");
				}

				this.answerLenInput.min = 1;
				this.answerLenInput.max = maxCodeLen;

				const lenKey = `${this.zigenConfig.name}_${this.zigenConfig.version}_answer_len`;
				this.answerLenInput.value = localStorage.getItem(lenKey) || maxCodeLen;

				this.answerLenInput.onchange = function () {
					localStorage.setItem(lenKey, self.answerLenInput.value);
				}
			}

			renderZigen(goNext = true) {
				if (!this.zigenConfig || !this.currentGlyphs || this.currentGlyphs.length == 0) {
					throw new Error("No config or glyphs");
				}

				// choose next index
				if (goNext) {
					if (this.shouldShowRandomZigen) {
						this.currentIndex = Math.floor(Math.random() * this.currentGlyphs.length);
					} else {
						this.currentIndex++;
						if (this.currentIndex >= this.currentGlyphs.length) {
							this.currentIndex = 0;
						}
					}
				}

				var indexKey = `${this.zigenConfig.name}_${this.zigenConfig.version}_index`;
				localStorage.setItem(indexKey, this.currentIndex);
				console.log(`Saving index [${indexKey}: ${this.currentIndex}]`);

				this.currentGlyph = this.currentGlyphs[this.currentIndex];
				console.log(`Choose glyph ${this.currentIndex}: [${this.currentGlyph.code}, ${this.currentGlyph.repr}]`);

				// render
				this.glyph.innerText = this.currentGlyph.glyph || "";
				this.glyphContext.innerText = this.currentGlyph.context || "";

				this.refreshCode();
				this.refreshTips();
			}
		};
	</script>

	<script>
		const app = new App();
		app.loadConfig('config.json');
	</script>
</body>

</html>
